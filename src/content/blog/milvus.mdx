---
heroImage: /src/assets/images/4jhau2076uhb1.png
category: 学习
description: milvus使用经验
pubDate: 2024-07-31T16:00:00.000Z
draft: true
tags:
  - docker
  - milvus
title: milvus使用记录
---

## 1. 安装

[`官方docker安装参考地址`](https://milvus.io/docs/install_standalone-docker.md#Run-Milvus-in-Docker)

```shell
# 当前版本 milvusdb/milvus:v2.4.5
# 下载脚本
curl -sfL https://raw.githubusercontent.com/milvus-io/milvus/master/scripts/standalone_embed.sh -o standalone_embed.sh

# 运行脚本
bash standalone_embed.sh start

# 如果出错先删除再重启
bash standalone_embed.sh delete
```

## 2. 创建

```python
from pymilvus import MilvusClient
# 创建客户端
client = MilvusClient(
  uri = "http://172.20.217.63:19530"
)
```

```python
from pymilvus import FieldSchema, DataType, CollectionSchema
from pprint import pprint

# 创建集合
# 集合名
collection_name = "journal_title_vector"

id_field = FieldSchema(name="id", dtype=DataType.INT64, is_primary=True, description="primary id")
article_id_field = FieldSchema(name="article_id", dtype=DataType.VARCHAR, description="journal article id", max_length=32)
embedding_field = FieldSchema(name="vector", dtype=DataType.FLOAT_VECTOR, dim=768, description="vector")

schema = CollectionSchema(fields=[id_field, article_id_field, embedding_field], auto_id=False, description="journal article", enable_dynamic_field=True)

schema
```

```python
# 创建索引
# 4.1.Set up the index parameters
index_params = MilvusClient.prepare_index_params()

# 4.2.Add an index on the vector field.
  index_params.add_index(
    field_name = "vector",
  )

# 4.3.Create an index file
client.create_index(
  collection_name = collection_name,
  index_params = index_params
)
```

## 3. 使用

```python
# 插入数据
data = []

for i in range(len(df)):
  data.append({
    "id": i,
    "article_id": df['id'][i],
        # "title": df['title'][i],
    "vector": title_embeddings[i].tolist()
  })

res = client.insert(
  collection_name = collection_name,
  data = data,
  schema = schema
)
res
```

```python
# 加载数据集
client.load_collection(
    collection_name=collection_name,
    replica_number=1
)

client.get_load_state(
    collection_name=collection_name
)
```

```python
# 查询
embedding = model.encode('致一公司国际物流管理改进研究')
res = client.search(
  collection_name = collection_name,
  data = [embedding.tolist()],
  limit = 2,
    # search_params = {
    #     "metric_type": "L2",
    # },
  output_fields = ["article_id"]
)
res[0]
```
